---
title: "Flexdashboard on Korean Rap"
author: "Jardel Barrow"
date: "7-4-2022"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    orientation: columns
    vertical_layout: fill
    theme: sandstone
---

```{r setup, include=FALSE}
library(gridExtra)
library(cowplot)
library(flexdashboard)
library(tidyverse)
library(spotifyr)
library(plotly)
library(compmus)
library(factoextra)
SMTM10 <- get_playlist_audio_features("", "2O89s4riuZyL4JcXFz18v1") %>% mutate(season="SMTM season 10")

SMTM9 <- get_playlist_audio_features("", "6qa0m7nvnOSU6Hwx8WkjCF") %>% mutate(season="SMTM season 9")

SMTM8 <- get_playlist_audio_features("", "7mELs4UaYz7T16JjgjWTYM") %>% mutate(season="SMTM season 8")

SMTM7 <- get_playlist_audio_features("", "3LGXYlT6z9XFGWfRp2v4K7") %>% mutate(season="SMTM season 7")

SMTM7 <- SMTM7[1:29,]

SMTM10 <- SMTM10[1:31,]

HSR1 <- get_playlist_audio_features("", "7JVFL7AYfMBlR41lV8ADjy") %>% mutate(season="HSR SEASON 1")

HSR2 <- get_playlist_audio_features("", "0DBlm2LNBAVRMZdDzo0C1g") %>% mutate(season="HSR SEASON 2")

HSR3 <- get_playlist_audio_features("", "1lP8NlSXXRoaWkMRGtRlxx") %>% mutate(season="HSR SEASON 3")

HSR4 <- get_playlist_audio_features("", "4cfqKlMZdA1uQ7iJT5ITyj") %>% mutate(season="HSR SEASON 4")


HSR <- rbind(HSR1, HSR2)  
HSR <- rbind(HSR, HSR3)
HSR <- rbind(HSR, HSR4)

SMTM <- rbind(SMTM7, SMTM8)
SMTM <- rbind(SMTM, SMTM9)
SMTM <- rbind(SMTM, SMTM10)

TOTAL <- rbind(SMTM, HSR)

TOTAL <- within(TOTAL,  { producer = "Others"
producer[str_detect(track.name, "Prod. Bangroz")] = "Bangroz" 
producer[str_detect(track.name, "Prod. GroovyRoom")] = "GroovyRoom" 
producer[str_detect(track.name, "Prod. BOYCOLD")] = "BOYCOLD" 
producer[str_detect(track.name, "Prod. Slom")] = "Slom" 
producer[str_detect(track.name, "Prod. CODE KUNST")] = "Code Kunst"

producer[str_detect(track.name, "Prod. GRAY")] = "Gray"

producer[str_detect(track.name, "Prod. by Bangroz")] = "Bangroz" 
producer[str_detect(track.name, "Prod. by GroovyRoom")] = "GroovyRoom" 
producer[str_detect(track.name, "Prod. by BOYCOLD")] = "BOYCOLD" 
producer[str_detect(track.name, "Prod. by Slom")] = "Slom" 
producer[str_detect(track.name, "Prod. by CODE KUNST")] = "Code Kunst"

producer[str_detect(track.name, "Prod. by GRAY")] = "Gray"

producer[str_detect(track.name, "Prod. Way Ched")] = "Way Ched"

producer[str_detect(track.name, "Prod. by Way Ched")] = "Way Ched"

producer[str_detect(track.name, "Prod. by Tiger JK")] = "Tiger JK"

producer[str_detect(track.name, "Prod. Tiger JK")] = "Tiger JK"

producer[str_detect(track.name, "Prod. by TOIL")] = "Toil"

producer[str_detect(track.name, "Prod. TOIL")] = "Toil"

producer[str_detect(track.name, "Prod. by Primary")] = "Primary"

producer[str_detect(track.name, "Prod. Primary")] = "Primary"

producer[str_detect(track.name, "Prod. by MINO")] = "Mino"

producer[str_detect(track.name, "Prod. MINO")] = "Mino"

producer[str_detect(track.name, "Prod. by WOOGIE")] = "Woogie"

producer[str_detect(track.name, "Prod. WOOGIE")] = "Woogie"





})  

Producers <- TOTAL %>% filter(producer != "NA")

Producer_Matrix <- Producers$tempo
Kmeans_producers <- kmeans(Producer_Matrix, centers= 10)

Producers_with_pred <- mutate(Producers, cluster=Kmeans_producers$cluster)

Producers_kmeans_plot <- ggplot(Producers_with_pred, aes(x = valence, y =tempo, color = factor(cluster), label=producer)) +     geom_point() + geom_text(hjust=.5, vjust=2, size=1) + theme(legend.position="none")


Season_Matrix <- Producers$tempo
Kmeans_seasons <- kmeans(Season_Matrix, centers= 15)

Seasons_with_pred <- mutate(Producers, cluster=Kmeans_seasons$cluster)

Seasons_kmeans_plot <- ggplot(Producers_with_pred, aes(x = valence,y =tempo, color = factor(cluster), label=season)) +     geom_point() + geom_text(hjust=.5, vjust=2, size=1) + theme(legend.position="none")

```
### Introduction
For many Korean artists, the path to fame is not simple. While the road for rap artists used to be harder, the introduction of rap competitions where rappers can co-produce with famous producers was an important milestone.

In my portfolio I decided to take a look at the two most famous examples: Show me the money and Highschool rapper. After passing preliminary elimination rounds contestants are teamed up under producer teams. As the producers vary by season, the interesting topic that we look to identify is whether the producers that appear in different seasons showcase any resemblances and whether producers that appear in multiple seasons change things up. 

The data exists of all Show me the Money and Highschool rapper discography with a total of 213 songs (121 and 92 respectively) with the four latest seasons included for each show.

While the producer was not always annotated in the name, the producers Code Kunst and Way ched exclusively to multiple seasons without any mentions in the other show. 


### Season and Producer predictions
```{r}
plot_grid(Producers_kmeans_plot, Seasons_kmeans_plot, labels=c("Producers", "Seasons"), hjust="outward", heights=c(4,8),ncol=2, nrow=1)


```

***
As the usage of beats made by producers heavily depends on whether they are part of a team in a season. Similarly finding out what season songs are expected to be from (especially with newer trends emerging) also seemed interesting. When trying to predict both using the kmeans algorithm (with 15 and 8 centers respectively) the results turned out quite interesting. Depending on the producer the results were better than others, which I found not very surprising. Especially the producer Code Kunst has been a mainstay in SMTM and the different classifications could very well be more about the different flavours he brought to different seasons. Another argument that could be made is that producers tend to search for beats that fit particularly well with a given artist thus the diversity in artists might be even more important.    

### Chordogram of the latest winners.
``` {r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )

Ooh_wah <-
  get_tidy_audio_analysis("71lQtAihaaI5YnWJnZzxPq") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Ooh_wah_plot <- Ooh_wah %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")

Boong_boong <-
  get_tidy_audio_analysis("3uJN5Acv1WMsITAEvHuJox") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Boong_boong_plot <- Boong_boong %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")

plot_grid(Boong_boong_plot, Ooh_wah_plot, labels=c("Boong-boong", "Ooh_wah"), hjust="outward", heights=c(2,4),ncol=1, nrow=2)

```

***
What is interesting is that both plots showcase similar chord usages. Might there be a winning formula for rap competitions? (Pending Linear regression winners )

### Chronogram of the song with the highest voting percentage in all of HSR: Boong-Boong

``` {r}
BMBM <-
  get_tidy_audio_analysis("3uJN5Acv1WMsITAEvHuJox") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

BMBM %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) + ggtitle("Chroma: Boong-boong (Kim Ha-on)")+
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()

```

***
Moving forward from the producer characteristics (See "Producer characterstics for now"), there is one outlier in the valence metric that turns out to be very special: The finals song of the second season by Kim Ha-on won the largest share of any finals performance (26.8%) by a large margin (Next closest winning performance achieved 23.7%)

As can be seen in the chronogram the song is all over the place other than the standard occurences of the C, G and G#/Ab tones. The melody in especially the chorus is very apparent compared to how one would hear it: The melody of the flute in this song screams out free and listening to this song once the chorus hits makes it clear that the frequent occurences of the spikes in other tones can be largely tied down to the melody of the flute going wild. 

### Timbre features
``` {r}
bzt <-
  get_tidy_audio_analysis("3uJN5Acv1WMsITAEvHuJox") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )


bzt2 <-
  get_tidy_audio_analysis("71lQtAihaaI5YnWJnZzxPq") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "manhattan"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "manhattan"              # Change summary & norm.
      )
  )


bztplot <- bzt %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") + ggtitle("Boong-boong")+
  scale_fill_viridis_c() +              
  theme_classic()



bztplot2 <- bzt2 %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") + ggtitle("Ooh wah")+
  scale_fill_viridis_c() +              
  theme_classic()

cowplot:: plot_grid(bztplot, bztplot2,hjust="outward", heights=c(30,15) )
```

*** 
When comparing the song "Boong-boong" to the last winner's song (Ooh wah), the frquencies of the former seem to be slightly more spread out in comparison to the densely populated Ooh wah. Overall both songs score very similar in valence and tempo and without looking at the data I would easily put these songs together as the songs that can easily be perceived as having a similar vibe among all discography used in this portfolio. Might there be a winning formula then? (work in progress: Linear regression for final performances per season) 



### Producer characteristics

``` {r}


TOTAL_plot_valence <- ggplot(Producers, aes(y=valence, x=tempo, label=track.name))+ geom_point(aes(color=producer)) +  xlab("Tempo") + geom_text(aes( label=ifelse(valence>0.85,as.character(track.name),'')), hjust="inward", vjust="inward", size=1.5)+ 
ylab("Track valence") + theme_dark() 

TOTAL_plot_energy <- ggplot(Producers, aes(y=energy, x=tempo, label=track.name))+ geom_point(aes(color=producer)) + geom_text(aes(label=ifelse(energy>0.9,as.character(track.name),'')), hjust="inward", vjust="inward", size=1.5) +  xlab("Tempo") + 
ylab("Energy") + theme_dark() 


plot_grid(TOTAL_plot_valence, TOTAL_plot_energy, labels=c("Valence", "Energy"), hjust="outward", heights=c(2,4),ncol=1, nrow=2)

```



***
While initially the plan was to compare start with a comparison of different seasons, the rotating door that is producer choices are such that, excluding CODE KUNST, most producers do not appear in more than two seasons. Of all the songs in which the producer name has been mentioned, the plot shows very differing results.

First off: The valence and energy portrayed in competition songs never dipped below 0.5 and 0.28 respectively. Moreover, the broad range in tempo, valence and energy signify that there is no one-fits-all solution when choosing a beat for most producers. 

Most notably three of the highest scoring songs on energy were all produced by the same producer. What seems to be fairly odd to me is that the song Wot wot scored as high as it did: From my point of view the itself has a very indifferent feeling to it. 

### BOXPLOT_Seasons
 ``` {r}
 group_by_album <- HSR %>% group_by(season)

group_by_album2 <- SMTM %>% group_by(season)


group_album_plot1 <- ggplot(group_by_album, aes(x=season, y=tempo, color=season)) + geom_boxplot() + theme(legend.title= element_blank(), axis.text.x=element_blank())
 
group_album_plot2 <- ggplot(group_by_album2, aes(x=season, y=tempo, color=season)) + geom_boxplot() + theme(legend.title= element_blank(), axis.text.x=element_blank()) 

plot_grid(group_album_plot1, group_album_plot2, labels=c("Highschool Rapper", "Show me The money"), heights=c(4,2), nrow=1, ncol=2)

 
 ```
 
### Concluding thoughts
From what I have been able to witness so far, the popification of Higschool rapper is very apparent in the changing trend of valence throughout the seasons. There does not seem to be any distinctive trend of features of Show me The money songs. 

### 